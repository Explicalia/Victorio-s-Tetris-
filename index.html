<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#05050f">
<meta name="description" content="Tetris por Explicalia â€” El juego de bloques definitivo, diseÃ±ado para pantallas de bolsillo.">
<meta name="mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">
<meta property="og:title" content="Tetris Â· Explicalia">
<meta property="og:description" content="El juego de bloques definitivo.">
<meta property="og:type" content="website">
<link rel="manifest" href="data:application/json,{}">
<title>Tetris Â· Explicalia</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TETRIS Â· EXPLICALIA SYSTEM â€” Production v5.0
   Tested: iPhone SEâ†’15 Pro Max / iPad Miniâ†’Pro 12.9
           Galaxy S21â†’S24 / Pixel 6â†’8 / Android tablets
           Chrome, Safari, Firefox, Samsung Internet
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
/* Typography */
â€“f-display: â€˜DM Sansâ€™, -apple-system, â€˜SF Pro Displayâ€™, BlinkMacSystemFont, â€˜Helvetica Neueâ€™, sans-serif;
â€“f-body: â€˜Space Groteskâ€™, -apple-system, â€˜SF Pro Textâ€™, BlinkMacSystemFont, sans-serif;

/* Core palette */
â€“bg: #05050f;
â€“surface: rgba(18, 18, 34, 0.88);
â€“glass-border: rgba(255, 255, 255, 0.1);
â€“glass-shine: rgba(255, 255, 255, 0.06);
â€“blur: saturate(180%) blur(20px);

/* Safe areas */
â€“sat: env(safe-area-inset-top, 0px);
â€“sab: env(safe-area-inset-bottom, 0px);
â€“sal: env(safe-area-inset-left, 0px);
â€“sar: env(safe-area-inset-right, 0px);

/* Easing */
â€“spring: cubic-bezier(.34, 1.56, .64, 1);
â€“ease-out: cubic-bezier(.22, 1, .36, 1);

/* System accent colours */
â€“blue: #007AFF;
â€“indigo: #5856D6;
â€“purple: #AF52DE;
â€“pink: #FF2D55;
â€“red: #FF3B30;
â€“orange: #FF9500;
â€“yellow: #FFCC00;
â€“green: #34C759;
â€“teal: #30B0C7;
â€“cyan: #32ADE6;

/* Piece colours */
â€“cI: #00d4e8;
â€“cO: #ffd000;
â€“cT: #b44fdb;
â€“cS: #2ed158;
â€“cZ: #ff3b30;
â€“cJ: #0a7cff;
â€“cL: #ff9f0a;

/* Responsive spacing scale */
â€“sp-xs: clamp(2px, 0.5vmin, 4px);
â€“sp-sm: clamp(4px, 1vmin, 8px);
â€“sp-md: clamp(8px, 2vmin, 16px);
â€“sp-lg: clamp(12px, 3vmin, 24px);
â€“sp-xl: clamp(16px, 4vmin, 32px);
}

/* â”€â”€ RESET â”€â”€ */
*, *::before, *::after {
box-sizing: border-box;
margin: 0;
padding: 0;
-webkit-tap-highlight-color: transparent;
-webkit-touch-callout: none;
}

html, body {
width: 100%;
height: 100%;
background: var(â€“bg);
color: #fff;
overflow: hidden;
font-family: var(â€“f-body);
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
text-rendering: optimizeLegibility;
}

body {
touch-action: none;
position: fixed;
inset: 0;
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
*, *::before, *::after {
animation-duration: 0.01ms !important;
animation-iteration-count: 1 !important;
transition-duration: 0.01ms !important;
}
}

/* â”€â”€ AMBIENT BACKGROUND â”€â”€ */
#amb {
position: fixed;
inset: 0;
z-index: 0;
pointer-events: none;
overflow: hidden;
will-change: transform;
}

.orb {
position: absolute;
border-radius: 50%;
filter: blur(80px);
animation: drift linear infinite;
will-change: transform;
}

@keyframes drift {
0%   { transform: translate(0, 0) scale(1); }
33%  { transform: translate(28px, -36px) scale(1.09); }
66%  { transform: translate(-18px, 28px) scale(.93); }
100% { transform: translate(0, 0) scale(1); }
}

/* Line-clear flash overlay */
#lf {
position: fixed;
inset: 0;
z-index: 900;
pointer-events: none;
opacity: 0;
background: radial-gradient(ellipse at 50% 40%, rgba(0, 122, 255, .18), transparent 70%);
transition: opacity .06s;
}
#lf.on { opacity: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCREEN SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app {
position: fixed;
inset: 0;
z-index: 1;
}

.scr {
position: absolute;
inset: 0;
display: none;
flex-direction: column;
overflow: hidden;
animation: scrIn .32s var(â€“ease-out) both;
}
.scr.on { display: flex; }

@keyframes scrIn {
from { opacity: 0; transform: translateY(8px); }
to   { opacity: 1; transform: translateY(0); }
}

/* Scrollable wrapper */
.sw {
overflow-y: auto;
overflow-x: hidden;
-webkit-overflow-scrolling: touch;
overscroll-behavior-y: contain;
flex: 1;
min-height: 0;
scrollbar-width: thin;
scrollbar-color: rgba(255,255,255,.1) transparent;
}
.sw::-webkit-scrollbar { width: 3px; }
.sw::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 2px; }

/* â”€â”€ SHARED BUTTONS â”€â”€ */
.btn {
display: block;
width: 100%;
padding: clamp(14px, 3.5vmin, 18px) 20px;
border: none;
border-radius: 14px;
cursor: pointer;
font-size: clamp(.88rem, 2.4vmin, 1.05rem);
font-weight: 700;
font-family: var(â€“f-body);
color: #fff;
background: linear-gradient(135deg, var(â€“blue) 0%, var(â€“indigo) 100%);
box-shadow: 0 1px 0 rgba(255,255,255,.22) inset, 0 5px 20px rgba(0,122,255,.36);
position: relative;
overflow: hidden;
letter-spacing: .3px;
transition: transform .12s var(â€“spring), box-shadow .12s;
will-change: transform;
}
.btn::before {
content: â€˜â€™;
position: absolute;
inset: 0;
background: linear-gradient(to bottom, rgba(255,255,255,.16), transparent);
pointer-events: none;
}
.btn:active {
transform: scale(.97);
box-shadow: 0 2px 8px rgba(0,122,255,.22);
}
.btn.ghost {
background: var(â€“surface);
backdrop-filter: var(â€“blur);
-webkit-backdrop-filter: var(â€“blur);
border: 1px solid var(â€“glass-border);
box-shadow: none;
color: rgba(255,255,255,.68);
font-weight: 600;
}
.btn.ghost:active { background: rgba(255,255,255,.1); }
.btn.red {
background: linear-gradient(135deg, var(â€“pink), var(â€“purple));
box-shadow: 0 5px 18px rgba(255,45,85,.3);
}
.btn.green {
background: linear-gradient(135deg, var(â€“green), var(â€“teal));
box-shadow: 0 5px 18px rgba(52,199,89,.28);
}
.slbl {
font-size: clamp(.55rem, 1.4vmin, .65rem);
font-weight: 700;
letter-spacing: 1.8px;
text-transform: uppercase;
color: rgba(255,255,255,.27);
margin-bottom: 9px;
font-family: var(â€“f-body);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCREEN 1 â€” LANDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s1 {
background: linear-gradient(165deg, #0c0c24 0%, #080610 55%, #0a0808 100%);
}

#rain {
position: absolute;
inset: 0;
z-index: 0;
pointer-events: none;
}

.l-wrap {
position: relative;
z-index: 1;
max-width: 500px;
margin: 0 auto;
padding: calc(var(â€“sat) + clamp(16px, 4vmin, 28px)) 20px calc(var(â€“sab) + 30px);
display: flex;
flex-direction: column;
align-items: center;
}

/* Brand block */
.brand {
display: flex;
flex-direction: column;
align-items: center;
text-align: center;
margin-bottom: clamp(16px, 4vmin, 28px);
}

.logo-box {
width: clamp(60px, 16vmin, 80px);
height: clamp(60px, 16vmin, 80px);
border-radius: 22px;
background: linear-gradient(145deg, #12123c, #1e1054);
border: 1px solid rgba(255,255,255,.14);
box-shadow: 0 12px 36px rgba(80,40,255,.28), 0 0 0 1px rgba(255,255,255,.04) inset;
display: flex;
align-items: center;
justify-content: center;
margin-bottom: clamp(12px, 3vmin, 20px);
position: relative;
overflow: hidden;
}
.logo-box::after {
content: â€˜â€™;
position: absolute;
top: 0; left: 0; right: 0;
height: 45%;
background: linear-gradient(to bottom, rgba(255,255,255,.14), transparent);
border-radius: 22px 22px 0 0;
}

.logo-g {
display: grid;
grid-template-columns: repeat(3, 13px);
grid-template-rows: repeat(3, 13px);
gap: 3px;
}
.lc { border-radius: 3px; }

.sys-pill {
display: inline-flex;
align-items: center;
gap: 7px;
background: rgba(255,255,255,.05);
border: 1px solid rgba(255,255,255,.1);
border-radius: 20px;
padding: 5px 12px 5px 9px;
font-size: .62rem;
font-weight: 700;
letter-spacing: 1.5px;
text-transform: uppercase;
color: rgba(255,255,255,.38);
margin-bottom: 14px;
}
.sys-dot {
width: 7px; height: 7px;
border-radius: 50%;
background: var(â€“green);
box-shadow: 0 0 7px var(â€“green);
animation: blink 2.2s ease infinite;
}
@keyframes blink { 0%,100%{opacity:1;} 50%{opacity:.35;} }

.brand-t {
font-family: var(â€“f-display);
font-size: clamp(3rem, 13vw, 5.2rem);
font-weight: 900;
letter-spacing: -3px;
line-height: .88;
margin-bottom: 8px;
background: linear-gradient(135deg, var(â€“cyan) 0%, var(â€“blue) 28%, var(â€“indigo) 52%, var(â€“purple) 74%, var(â€“pink) 100%);
background-size: 200% auto;
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
animation: shimmer 5s linear infinite;
}
@keyframes shimmer { to { background-position: 200% center; } }

.brand-by {
font-size: .78rem;
letter-spacing: 3px;
text-transform: uppercase;
color: rgba(255,255,255,.26);
margin-bottom: 2px;
}
.brand-n {
font-family: var(â€“f-display);
font-size: clamp(1.1rem, 3.5vmin, 1.4rem);
font-weight: 600;
color: rgba(255,255,255,.72);
margin-bottom: 6px;
}
.brand-tag {
font-size: clamp(.74rem, 2vmin, .85rem);
color: rgba(255,255,255,.3);
line-height: 1.55;
max-width: 240px;
}

/* Stats row */
.l-stats {
display: grid;
grid-template-columns: 1fr 1fr 1fr;
gap: clamp(6px, 1.5vmin, 10px);
width: 100%;
margin-bottom: clamp(14px, 3.5vmin, 22px);
}
.ls {
background: rgba(255,255,255,.04);
border: 1px solid rgba(255,255,255,.07);
border-radius: 13px;
padding: clamp(8px, 2vmin, 13px) 8px;
text-align: center;
}
.ls-l {
font-size: clamp(.5rem, 1.3vmin, .58rem);
letter-spacing: 1.2px;
text-transform: uppercase;
color: rgba(255,255,255,.24);
margin-bottom: 3px;
}
.ls-v {
font-family: var(â€“f-display);
font-size: clamp(.95rem, 2.8vmin, 1.2rem);
font-weight: 800;
font-variant-numeric: tabular-nums;
}

/* Mode selector */
.mode-g { width: 100%; margin-bottom: clamp(14px, 3.5vmin, 20px); }
.mode-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: clamp(6px, 1.5vmin, 10px);
}
.mc {
background: rgba(255,255,255,.04);
border: 1px solid rgba(255,255,255,.08);
border-radius: 14px;
padding: clamp(10px, 2.5vmin, 15px) 10px;
text-align: center;
cursor: pointer;
transition: background .15s var(â€“spring), border-color .15s, transform .12s var(â€“spring);
-webkit-user-select: none;
user-select: none;
}
.mc:active { transform: scale(.97); }
.mc.on {
background: rgba(0,122,255,.2);
border-color: rgba(0,122,255,.44);
box-shadow: 0 0 0 1px rgba(0,122,255,.18) inset;
}
.mc .mi { font-size: 1.3rem; display: block; margin-bottom: 4px; }
.mc .mn { font-size: clamp(.68rem, 1.9vmin, .78rem); font-weight: 700; color: rgba(255,255,255,.66); }
.mc .md { font-size: clamp(.54rem, 1.4vmin, .62rem); color: rgba(255,255,255,.28); margin-top: 1px; }
.mc.on .mn { color: #fff; }

/* CTAs */
.l-ctas {
width: 100%;
display: flex;
flex-direction: column;
gap: 10px;
margin-bottom: clamp(16px, 4vmin, 24px);
}

/* Footer */
.l-foot { text-align: center; margin-top: 4px; }
.lf1 {
font-size: .61rem;
letter-spacing: 1.8px;
text-transform: uppercase;
color: rgba(255,255,255,.17);
}
.lf1 a {
color: rgba(255,255,255,.28);
text-decoration: none;
font-weight: 600;
}
.lf2 {
font-size: .56rem;
color: rgba(255,255,255,.1);
margin-top: 2px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCREEN 2 â€” MANUAL (bottom sheet)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s2 {
background: rgba(0,0,0,.78);
backdrop-filter: blur(10px);
-webkit-backdrop-filter: blur(10px);
justify-content: flex-end;
}

.m-sheet {
background: #141428;
border-radius: 24px 24px 0 0;
border: 1px solid rgba(255,255,255,.1);
border-bottom: none;
max-height: 92dvh;
max-height: 92vh; /* fallback */
display: flex;
flex-direction: column;
box-shadow: 0 -20px 60px rgba(0,0,0,.9);
transform: translateY(100%);
transition: transform .38s var(â€“spring);
will-change: transform;
}
#s2.on .m-sheet { transform: translateY(0); }

.mh {
width: 36px; height: 4px;
border-radius: 2px;
background: rgba(255,255,255,.18);
margin: 10px auto 0;
flex-shrink: 0;
}
.mhd {
display: flex;
align-items: center;
justify-content: space-between;
padding: 12px 18px;
flex-shrink: 0;
border-bottom: 1px solid rgba(255,255,255,.07);
}
.mhd-t {
font-family: var(â€“f-display);
font-size: .95rem;
font-weight: 700;
}
.mhd-x {
width: 28px; height: 28px;
border-radius: 50%;
background: rgba(255,255,255,.09);
border: none;
color: #fff;
font-size: .85rem;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
font-family: var(â€“f-body);
}
.mb {
overflow-y: auto;
-webkit-overflow-scrolling: touch;
padding: 16px 18px calc(20px + var(â€“sab));
flex: 1;
scrollbar-width: thin;
scrollbar-color: rgba(255,255,255,.1) transparent;
}
.mb::-webkit-scrollbar { width: 3px; }
.mb::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 2px; }
.mf {
padding: 12px 18px calc(12px + var(â€“sab));
border-top: 1px solid rgba(255,255,255,.07);
flex-shrink: 0;
}

/* Manual content */
.mhero {
background: linear-gradient(135deg, rgba(0,122,255,.12), rgba(175,82,222,.12));
border: 1px solid rgba(255,255,255,.07);
border-radius: 16px;
padding: 20px 16px;
text-align: center;
margin-bottom: 20px;
}
.mhero-t {
font-family: var(â€“f-display);
font-size: 1.5rem;
font-weight: 900;
letter-spacing: -1px;
background: linear-gradient(90deg, var(â€“cyan), var(â€“blue), var(â€“indigo));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
margin-bottom: 5px;
}
.mhero-s { font-size: .77rem; color: rgba(255,255,255,.38); line-height: 1.55; }

.msec { margin-bottom: 20px; }

.mcard {
background: rgba(255,255,255,.03);
border: 1px solid rgba(255,255,255,.07);
border-radius: 14px;
overflow: hidden;
}
.mrow {
display: flex;
align-items: flex-start;
gap: 12px;
padding: 12px 14px;
border-bottom: 1px solid rgba(255,255,255,.04);
}
.mrow:last-child { border-bottom: none; }
.mico {
width: 36px; height: 36px;
border-radius: 10px;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.05rem;
flex-shrink: 0;
}
.mtxt h4 { font-size: .84rem; font-weight: 600; margin-bottom: 2px; font-family: var(â€“f-display); }
.mtxt p  { font-size: .72rem; color: rgba(255,255,255,.4); line-height: 1.55; }

.stbl {
background: rgba(255,255,255,.03);
border: 1px solid rgba(255,255,255,.07);
border-radius: 14px;
overflow: hidden;
}
.srow {
display: flex;
justify-content: space-between;
align-items: center;
padding: 9px 14px;
border-bottom: 1px solid rgba(255,255,255,.04);
}
.srow:last-child { border-bottom: none; }
.sn { font-size: .8rem; color: rgba(255,255,255,.64); }
.sp { font-size: .76rem; font-weight: 700; color: var(â€“cyan); font-variant-numeric: tabular-nums; }

.tip {
background: rgba(0,122,255,.08);
border: 1px solid rgba(0,122,255,.15);
border-radius: 13px;
padding: 12px 14px;
display: flex;
gap: 10px;
margin-bottom: 8px;
}
.tip:last-child { margin-bottom: 0; }
.tii { font-size: .95rem; flex-shrink: 0; margin-top: 1px; }
.tip p { font-size: .73rem; color: rgba(255,255,255,.46); line-height: 1.55; }
.tip p strong { color: rgba(255,255,255,.82); font-weight: 600; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCREEN 3 â€” GAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s3 {
background: var(â€“bg);
overflow: hidden !important;
}

/* HUD bar */
#hud {
display: flex;
align-items: center;
gap: clamp(3px, .8vmin, 6px);
padding: calc(var(â€“sat) + clamp(2px, .5vmin, 4px)) clamp(6px, 1.5vmin, 12px) clamp(3px, .7vmin, 5px);
flex-shrink: 0;
}
.hp {
flex: 1;
text-align: center;
background: rgba(255,255,255,.04);
border: 1px solid rgba(255,255,255,.07);
border-radius: clamp(8px, 2vmin, 12px);
padding: clamp(3px, .6vmin, 5px) 3px;
min-width: 0;
}
.hp-l {
font-size: clamp(.42rem, 1.1vmin, .52rem);
font-weight: 700;
letter-spacing: 1px;
text-transform: uppercase;
color: rgba(255,255,255,.24);
line-height: 1;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}
.hp-v {
font-family: var(â€“f-display);
font-size: clamp(.78rem, 2.2vmin, 1rem);
font-weight: 800;
font-variant-numeric: tabular-nums;
letter-spacing: -.5px;
line-height: 1.2;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}
#hsc .hp-v { color: var(â€“cyan); }
#hli .hp-v { color: var(â€“green); }
#hlv .hp-v { color: var(â€“yellow); }
#hhi .hp-v { color: var(â€“orange); }

.hpb {
width: clamp(28px, 7vmin, 36px);
height: clamp(28px, 7vmin, 36px);
border-radius: 9px;
flex-shrink: 0;
background: rgba(255,255,255,.05);
border: 1px solid rgba(255,255,255,.08);
color: rgba(255,255,255,.5);
font-size: clamp(.7rem, 2vmin, .85rem);
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
font-family: var(â€“f-body);
}
.hpb:active { background: rgba(255,255,255,.12); }

/* Main game row */
#gmain {
flex: 1;
min-height: 0;
display: flex;
align-items: flex-start;
padding: clamp(2px, .5vmin, 5px) clamp(4px, 1vmin, 10px);
gap: clamp(3px, .7vmin, 6px);
position: relative;
overflow: hidden;
}

/* Side panels */
.gside {
width: clamp(42px, 11vmin, 64px);
flex-shrink: 0;
display: flex;
flex-direction: column;
gap: 4px;
}
.gbox {
background: rgba(255,255,255,.04);
border: 1px solid rgba(255,255,255,.07);
border-radius: clamp(9px, 2.2vmin, 13px);
padding: clamp(3px, .7vmin, 6px) clamp(2px, .5vmin, 5px);
display: flex;
flex-direction: column;
align-items: center;
gap: 3px;
}
.gbl {
font-size: clamp(.4rem, 1vmin, .5rem);
font-weight: 700;
letter-spacing: 1.2px;
text-transform: uppercase;
color: rgba(255,255,255,.21);
}
.gcv { display: block; }

/* Board wrapper */
#bwrap {
flex: 1;
min-height: 0;
height: 100%;
display: flex;
align-items: center;
justify-content: center;
position: relative;
overflow: hidden;
}

#board {
position: relative;
border: 1.5px solid rgba(0,170,255,.24);
border-radius: 6px;
overflow: hidden;
box-shadow:
0 0 0 1px rgba(0,170,255,.07),
0 0 45px rgba(0,50,160,.2),
inset 0 0 35px rgba(0,0,0,.5);
will-change: transform;
}
#gcvs { display: block; }

/* Floating feedback */
.fb {
position: absolute;
pointer-events: none;
z-index: 30;
font-weight: 900;
letter-spacing: -.5px;
font-family: var(â€“f-display);
}
.fb-pts {
font-size: clamp(.8rem, 2.2vmin, 1rem);
animation: fbUp .85s var(â€“ease-out) forwards;
}
@keyframes fbUp {
0%   { opacity: 1; transform: translateY(0) scale(1); }
100% { opacity: 0; transform: translateY(-52px) scale(1.25); }
}
.fb-combo {
font-size: clamp(.95rem, 2.8vmin, 1.2rem);
color: var(â€“yellow);
text-shadow: 0 0 14px var(â€“yellow);
animation: fbPop .85s var(â€“spring) forwards;
left: 50%;
transform: translateX(-50%);
white-space: nowrap;
}
@keyframes fbPop {
0%   { opacity: 0; transform: translateX(-50%) scale(.2); }
30%  { opacity: 1; transform: translateX(-50%) scale(1.1); }
100% { opacity: 0; transform: translateX(-50%) scale(1) translateY(-22px); }
}
.fb-tspin, .fb-ac, .fb-lv {
font-size: clamp(.62rem, 1.7vmin, .75rem);
padding: 3px 11px;
border-radius: 20px;
color: #fff;
animation: fbSlide 1.1s var(â€“spring) forwards;
left: 50%;
transform: translateX(-50%);
white-space: nowrap;
}
.fb-tspin { background: linear-gradient(90deg, var(â€“purple), var(â€“pink)); }
.fb-ac {
background: linear-gradient(90deg, var(â€“green), var(â€“teal));
box-shadow: 0 0 22px rgba(52,199,89,.45);
font-size: clamp(.68rem, 1.9vmin, .82rem);
letter-spacing: 1.5px;
top: 18%;
}
.fb-lv {
background: linear-gradient(90deg, var(â€“blue), var(â€“indigo));
box-shadow: 0 0 22px rgba(0,122,255,.4);
letter-spacing: 2px;
top: 30%;
}
@keyframes fbSlide {
0%  { opacity: 0; transform: translateX(-50%) translateY(8px); }
20% { opacity: 1; transform: translateX(-50%) translateY(0); }
75% { opacity: 1; }
100%{ opacity: 0; transform: translateX(-50%) translateY(-16px); }
}
@keyframes bShake {
0%,100% { transform: translateX(0); }
20%     { transform: translateX(-5px); }
40%     { transform: translateX(5px); }
60%     { transform: translateX(-3px); }
80%     { transform: translateX(3px); }
}
.shk { animation: bShake .28s ease-out; }

/* â”€â”€ CONTROLS â”€â”€ */
#gctrl {
flex-shrink: 0;
padding: clamp(3px, .7vmin, 5px) clamp(6px, 1.5vmin, 10px) calc(var(â€“sab) + clamp(4px, 1vmin, 8px));
display: flex;
flex-direction: column;
gap: clamp(3px, .7vmin, 6px);
}
.crow {
display: flex;
gap: clamp(3px, .7vmin, 6px);
justify-content: center;
}

.gb {
border: none;
border-radius: clamp(11px, 2.8vmin, 15px);
color: #fff;
font-weight: 800;
font-size: clamp(.95rem, 2.8vmin, 1.2rem);
font-family: var(â€“f-body);
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
height: clamp(44px, 11vmin, 60px);
background: rgba(20,20,38,.9);
backdrop-filter: var(â€“blur);
-webkit-backdrop-filter: var(â€“blur);
border: 1px solid rgba(255,255,255,.1);
box-shadow:
0 1px 0 rgba(255,255,255,.06) inset,
0 4px 0 rgba(0,0,0,.42),
0 5px 14px rgba(0,0,0,.25);
transition: transform .07s, box-shadow .07s;
-webkit-user-select: none;
user-select: none;
position: relative;
overflow: hidden;
will-change: transform;
}
.gb::before {
content: â€˜â€™;
position: absolute;
top: 0; left: 0; right: 0;
height: 42%;
background: linear-gradient(to bottom, rgba(255,255,255,.07), transparent);
pointer-events: none;
}
.gb:active {
transform: translateY(4px);
box-shadow: 0 0 0 rgba(0,0,0,0);
}

.gb-hl {
flex: 1.4;
font-size: clamp(.58rem, 1.6vmin, .72rem);
letter-spacing: 1px;
background: rgba(175,82,222,.2);
border-color: rgba(175,82,222,.3);
}
.gb-rl, .gb-rr {
width: clamp(44px, 11vmin, 58px);
flex-shrink: 0;
background: rgba(0,180,255,.14);
border-color: rgba(0,180,255,.24);
}
.gb-hd {
width: clamp(44px, 11vmin, 58px);
flex-shrink: 0;
background: rgba(255,208,0,.16);
border-color: rgba(255,208,0,.28);
color: var(â€“yellow);
}
.gb-le, .gb-ri {
width: clamp(44px, 11vmin, 58px);
flex-shrink: 0;
}
.gb-dn {
width: clamp(44px, 11vmin, 58px);
flex-shrink: 0;
background: rgba(0,122,255,.18);
border-color: rgba(0,122,255,.28);
}
.gb-ps {
width: 100%;
height: clamp(30px, 7.5vmin, 38px);
border-radius: clamp(9px, 2.2vmin, 12px);
font-size: clamp(.56rem, 1.5vmin, .68rem);
letter-spacing: 2px;
text-transform: uppercase;
color: rgba(255,255,255,.28);
background: rgba(255,255,255,.03);
border: 1px solid rgba(255,255,255,.06);
}
.hint {
text-align: center;
font-size: clamp(.46rem, 1.2vmin, .56rem);
letter-spacing: 1px;
color: rgba(255,255,255,.15);
text-transform: uppercase;
padding: 2px 0;
}

/* â”€â”€ ORIENTATION WARNING â”€â”€ */
#ow {
display: none;
position: fixed;
inset: 0;
z-index: 9999;
background: rgba(5,5,15,.98);
flex-direction: column;
align-items: center;
justify-content: center;
gap: 16px;
text-align: center;
padding: 32px;
}
.ow-ico { font-size: 3rem; animation: ri 2s ease infinite; }
@keyframes ri { 0%,100%{transform:rotate(0);} 50%{transform:rotate(-90deg);} }
.ow-txt { font-size: .9rem; color: rgba(255,255,255,.5); line-height: 1.6; }
.ow-txt strong { color: #fff; display: block; font-size: 1.1rem; margin-bottom: 4px; }
@media (max-height:500px) and (orientation:landscape) { #ow { display: flex; } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCREEN 4 â€” PAUSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s4 {
background: rgba(0,0,0,.86);
backdrop-filter: blur(14px);
-webkit-backdrop-filter: blur(14px);
align-items: center;
justify-content: center;
padding: 24px;
}
.pcard {
width: 100%;
max-width: 300px;
border-radius: 22px;
padding: clamp(22px, 5.5vmin, 32px) 20px;
display: flex;
flex-direction: column;
align-items: center;
gap: 14px;
background: var(â€“surface);
backdrop-filter: var(â€“blur);
-webkit-backdrop-filter: var(â€“blur);
border: 1px solid var(â€“glass-border);
box-shadow: 0 1px 0 var(â€“glass-shine) inset, 0 20px 60px rgba(0,0,0,.5);
}
.pt {
font-family: var(â€“f-display);
font-size: 2rem;
font-weight: 900;
letter-spacing: -1.5px;
color: var(â€“blue);
text-shadow: 0 0 28px rgba(0,122,255,.4);
}
.ps-w { text-align: center; }
.ps-l {
font-size: .57rem;
letter-spacing: 1.2px;
text-transform: uppercase;
color: rgba(255,255,255,.27);
}
.ps-v {
font-family: var(â€“f-display);
font-size: 1.9rem;
font-weight: 900;
font-variant-numeric: tabular-nums;
}
.pr {
width: 100%;
padding: 15px;
border: none;
border-radius: 13px;
background: linear-gradient(135deg, var(â€“blue), var(â€“indigo));
font-size: .95rem;
font-weight: 700;
font-family: var(â€“f-body);
color: #fff;
cursor: pointer;
box-shadow: 0 4px 18px rgba(0,122,255,.34);
transition: transform .12s var(â€“spring);
}
.pr:active { transform: scale(.97); }
.pq {
width: 100%;
padding: 13px;
border-radius: 12px;
cursor: pointer;
background: rgba(255,59,48,.1);
border: 1px solid rgba(255,59,48,.22);
font-size: .85rem;
font-weight: 600;
color: rgba(255,59,48,.8);
font-family: var(â€“f-body);
transition: background .12s;
}
.pq:active { background: rgba(255,59,48,.18); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCREEN 5 â€” GAME OVER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s5 {
background: radial-gradient(ellipse at 50% 0%, rgba(40,4,4,.97) 0%, rgba(6,5,15,.99) 100%);
}
.go-w {
max-width: 380px;
margin: 0 auto;
padding: calc(var(â€“sat) + clamp(16px, 4vmin, 24px)) 20px calc(var(â€“sab) + 30px);
display: flex;
flex-direction: column;
align-items: center;
gap: 0;
min-height: 100%;
}
.go-e {
font-size: clamp(2.2rem, 8vmin, 3rem);
margin-bottom: 8px;
animation: bIn .5s var(â€“spring) .1s both;
}
@keyframes bIn { from{transform:scale(0) rotate(-15deg);} to{transform:scale(1) rotate(0);} }

.go-t {
font-family: var(â€“f-display);
font-size: clamp(2.4rem, 10vw, 4rem);
font-weight: 900;
letter-spacing: -2.5px;
text-align: center;
line-height: .9;
margin-bottom: 10px;
color: var(â€“red);
text-shadow: 0 0 45px rgba(255,59,48,.35);
animation: bIn .4s var(â€“spring) .2s both;
}
.go-q {
font-size: clamp(.78rem, 2.2vmin, .92rem);
color: rgba(255,255,255,.44);
text-align: center;
line-height: 1.65;
margin-bottom: clamp(16px, 4vmin, 24px);
font-style: italic;
padding: 0 6px;
animation: fUp .5s var(â€“ease-out) .45s both;
}
@keyframes fUp { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }

.go-sb {
width: 100%;
background: rgba(255,59,48,.07);
border: 1px solid rgba(255,59,48,.18);
border-radius: 16px;
padding: clamp(12px, 3vmin, 18px);
text-align: center;
margin-bottom: 14px;
animation: fUp .4s var(â€“ease-out) .32s both;
}
.go-sb .gl {
font-size: .57rem;
letter-spacing: 1.5px;
text-transform: uppercase;
color: rgba(255,255,255,.26);
}
.go-sb .gv {
font-family: var(â€“f-display);
font-size: clamp(2rem, 6.5vmin, 2.8rem);
font-weight: 900;
letter-spacing: -2px;
font-variant-numeric: tabular-nums;
}
#nrec {
display: none;
font-family: var(â€“f-display);
font-size: .84rem;
font-weight: 800;
letter-spacing: 1px;
color: var(â€“yellow);
text-shadow: 0 0 12px var(â€“yellow);
text-align: center;
margin-bottom: 12px;
animation: rpulse 1.5s ease infinite;
}
@keyframes rpulse { 0%,100%{opacity:1;} 50%{opacity:.6;} }

.go-st {
width: 100%;
display: grid;
grid-template-columns: 1fr 1fr 1fr;
gap: clamp(6px, 1.5vmin, 10px);
margin-bottom: clamp(14px, 3.5vmin, 20px);
animation: fUp .4s var(â€“ease-out) .55s both;
}
.go-s {
background: rgba(255,255,255,.04);
border: 1px solid rgba(255,255,255,.07);
border-radius: 13px;
padding: clamp(8px, 2vmin, 13px) 6px;
text-align: center;
}
.go-sl {
font-size: clamp(.48rem, 1.3vmin, .57rem);
letter-spacing: 1px;
text-transform: uppercase;
color: rgba(255,255,255,.26);
margin-bottom: 2px;
}
.go-sv {
font-family: var(â€“f-display);
font-size: clamp(1rem, 3vmin, 1.3rem);
font-weight: 800;
font-variant-numeric: tabular-nums;
}
.go-ct {
width: 100%;
display: flex;
flex-direction: column;
gap: 9px;
animation: fUp .4s var(â€“ease-out) .65s both;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCREEN 6 â€” FAREWELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s6 {
background: radial-gradient(ellipse at 50% 100%, rgba(0,18,8,.98) 0%, rgba(5,5,15,.99) 60%);
}
.fw-w {
max-width: 360px;
margin: 0 auto;
padding: calc(var(â€“sat) + clamp(20px, 5vmin, 32px)) 20px calc(var(â€“sab) + 34px);
display: flex;
flex-direction: column;
align-items: center;
gap: 0;
min-height: 100%;
}
.fw-e {
font-size: clamp(2.4rem, 8vmin, 3.2rem);
margin-bottom: 12px;
animation: bIn .5s var(â€“spring) .1s both;
}
.fw-t {
font-family: var(â€“f-display);
font-size: clamp(1.6rem, 5.5vmin, 2.2rem);
font-weight: 900;
letter-spacing: -1.5px;
text-align: center;
margin-bottom: 8px;
color: var(â€“green);
text-shadow: 0 0 35px rgba(52,199,89,.3);
animation: fUp .4s var(â€“ease-out) .2s both;
}
.fw-q {
font-size: clamp(.78rem, 2.2vmin, .92rem);
color: rgba(255,255,255,.43);
text-align: center;
line-height: 1.65;
margin-bottom: 24px;
font-style: italic;
padding: 0 6px;
animation: fUp .4s var(â€“ease-out) .32s both;
}
.fw-q strong { color: rgba(255,255,255,.78); font-style: normal; font-weight: 600; }
.fw-hb {
width: 100%;
background: rgba(52,199,89,.07);
border: 1px solid rgba(52,199,89,.15);
border-radius: 16px;
padding: 16px;
text-align: center;
margin-bottom: 22px;
animation: fUp .4s var(â€“ease-out) .42s both;
}
.fw-hl {
font-size: .57rem;
letter-spacing: 1.5px;
text-transform: uppercase;
color: rgba(255,255,255,.25);
}
.fw-hv {
font-family: var(â€“f-display);
font-size: clamp(1.8rem, 6vmin, 2.5rem);
font-weight: 900;
letter-spacing: -2px;
font-variant-numeric: tabular-nums;
}
.fw-ct {
width: 100%;
display: flex;
flex-direction: column;
gap: 9px;
animation: fUp .4s var(â€“ease-out) .52s both;
}
.fw-cr {
margin-top: auto;
padding-top: 26px;
text-align: center;
animation: fUp .4s var(â€“ease-out) .62s both;
}
.fw-c1 {
font-size: .6rem;
letter-spacing: 1.8px;
text-transform: uppercase;
color: rgba(255,255,255,.15);
}
.fw-c1 a { color: rgba(255,255,255,.26); text-decoration: none; font-weight: 600; }
.fw-c2 { font-size: .55rem; color: rgba(255,255,255,.09); margin-top: 2px; }

/* Particles */
.ptc {
position: fixed;
border-radius: 50%;
pointer-events: none;
z-index: 999;
animation: ptcF .7s ease-out forwards;
}
@keyframes ptcF {
0%   { opacity: 1; transform: translate(0, 0) scale(1); }
100% { opacity: 0; transform: translate(var(â€“px), var(â€“py)) scale(0); }
}

/* Score counter animation */
@keyframes scorePop {
0%   { transform: scale(1); }
50%  { transform: scale(1.15); }
100% { transform: scale(1); }
}
.score-pop { animation: scorePop .2s var(â€“spring); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
COMPREHENSIVE RESPONSIVE SYSTEM
Fluid clamp() handles 90% of scaling.
Breakpoints handle structural changes.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Very small phones â€” iPhone SE, Galaxy A03 (â‰¤360px) */
@media (max-width: 360px) {
.brand-t { font-size: 2.6rem; letter-spacing: -2px; }
.hint { display: none; }
.gside { width: 40px; }
.gbl { font-size: .38rem; }
.hp { padding: 2px 2px; }
.hp-l { font-size: .4rem; letter-spacing: .5px; }
.hp-v { font-size: .72rem; }
.hpb { width: 26px; height: 26px; font-size: .65rem; }
}

/* Small phones â€” iPhone 12 mini (â‰¤375px) */
@media (max-width: 375px) and (min-width: 361px) {
.gside { width: 44px; }
}

/* Standard phones â€” iPhone 14/15, Pixel 7 (376â€“414px) */
@media (min-width: 376px) and (max-width: 414px) {
.gside { width: 50px; }
}

/* Large phones â€” iPhone Pro Max, Galaxy S24 Ultra (415â€“480px) */
@media (min-width: 415px) {
.gside { width: 56px; }
}

/* Small tablets â€” iPad Mini, Galaxy Tab (â‰¥600px) */
@media (min-width: 600px) {
.l-wrap { padding-top: calc(var(â€“sat) + 36px); }
.mode-grid, .l-ctas, .l-stats {
max-width: 420px;
margin-left: auto;
margin-right: auto;
}
.gside { width: 64px; }
}

/* Tablets â€” iPad Air (â‰¥768px) */
@media (min-width: 768px) {
.gside { width: 72px; }
.pcard { max-width: 340px; }
.m-sheet { max-width: 600px; margin: 0 auto; border-radius: 24px 24px 0 0; }
}

/* Large tablets â€” iPad Pro (â‰¥1024px) */
@media (min-width: 1024px) {
.l-wrap { max-width: 600px; }
.gside { width: 80px; }
#gmain { padding: 6px 16px; gap: 8px; }
#gctrl { padding: 6px 16px calc(var(â€“sab) + 8px); gap: 6px; }
.crow { gap: 6px; }
}

/* Very tall phones â€” extra vertical space (height â‰¥ 800px at phone width) */
@media (max-width: 480px) and (min-height: 800px) {
#gctrl { padding-bottom: calc(var(â€“sab) + 12px); }
.crow { gap: 5px; }
}

/* Short phones â€” reduced vertical space */
@media (max-height: 650px) and (max-width: 480px) {
.hint { display: none; }
.gb-ps { height: 26px; font-size: .5rem; }
#hud { padding-top: calc(var(â€“sat) + 1px); padding-bottom: 2px; }
.hp { padding: 2px 2px; border-radius: 7px; }
.hp-l { display: none; }
}

/* Android notch handling */
@supports (padding-top: env(safe-area-inset-top)) {
#hud { padding-top: calc(env(safe-area-inset-top, 0px) + clamp(2px, .5vmin, 4px)); }
#gctrl { padding-bottom: calc(env(safe-area-inset-bottom, 0px) + clamp(4px, 1vmin, 8px)); }
}
</style>

</head>
<body>

<div id="amb" aria-hidden="true">
  <div class="orb" style="width:340px;height:340px;top:-80px;left:-60px;background:radial-gradient(circle,rgba(0,60,200,.36),transparent 70%);animation-duration:24s;opacity:.4;"></div>
  <div class="orb" style="width:300px;height:300px;bottom:-50px;right:-40px;background:radial-gradient(circle,rgba(120,0,220,.3),transparent 70%);animation-duration:30s;animation-delay:-10s;opacity:.35;"></div>
  <div class="orb" style="width:200px;height:200px;top:42%;left:16%;background:radial-gradient(circle,rgba(0,150,200,.18),transparent 70%);animation-duration:20s;animation-delay:-6s;opacity:.38;"></div>
</div>
<div id="lf" aria-hidden="true"></div>

<!-- Landscape warning -->

<div id="ow" role="alert" aria-live="assertive">
  <div class="ow-ico" aria-hidden="true">ğŸ“±</div>
  <div class="ow-txt"><strong>Gira tu dispositivo</strong>Tetris funciona mejor en modo vertical.</div>
</div>

<div id="app">

<!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘  SCREEN 1 â€” LANDING             â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="scr on" id="s1" role="main">
  <canvas id="rain" aria-hidden="true"></canvas>
  <div class="sw">
    <div class="l-wrap">

```
  <div class="brand">
    <div class="logo-box" aria-hidden="true"><div class="logo-g" id="lgrid"></div></div>
    <div class="sys-pill"><div class="sys-dot"></div>Explicalia System</div>
    <h1 class="brand-t">TETRIS</h1>
    <div class="brand-by">por</div>
    <div class="brand-n">Explicalia</div>
    <p class="brand-tag">El juego de bloques definitivo,<br>diseÃ±ado para pantallas de bolsillo.</p>
  </div>

  <div class="l-stats" role="group" aria-label="EstadÃ­sticas">
    <div class="ls"><div class="ls-l">Tu rÃ©cord</div>
      <div class="ls-v" id="l-hi" style="color:var(--orange)">â€”</div></div>
    <div class="ls"><div class="ls-l">Partidas</div>
      <div class="ls-v" id="l-gm" style="color:var(--purple)">â€”</div></div>
    <div class="ls"><div class="ls-l">LÃ­neas</div>
      <div class="ls-v" id="l-li" style="color:var(--green)">â€”</div></div>
  </div>

  <div class="mode-g" role="radiogroup" aria-label="Modo de juego">
    <div class="slbl">Modo de juego</div>
    <div class="mode-grid">
      <div class="mc on" data-m="marathon" role="radio" aria-checked="true" tabindex="0" onclick="UI.mode(this,'marathon')">
        <span class="mi" aria-hidden="true">â™¾</span><div class="mn">MaratÃ³n</div><div class="md">Sin lÃ­mite Â· sube niveles</div></div>
      <div class="mc" data-m="sprint" role="radio" aria-checked="false" tabindex="0" onclick="UI.mode(this,'sprint')">
        <span class="mi" aria-hidden="true">âš¡</span><div class="mn">Sprint 40L</div><div class="md">MÃ¡s rÃ¡pido del mundo</div></div>
      <div class="mc" data-m="ultra" role="radio" aria-checked="false" tabindex="0" onclick="UI.mode(this,'ultra')">
        <span class="mi" aria-hidden="true">â±</span><div class="mn">Ultra 2min</div><div class="md">MÃ¡xima puntuaciÃ³n</div></div>
      <div class="mc" data-m="blitz" role="radio" aria-checked="false" tabindex="0" onclick="UI.mode(this,'blitz')">
        <span class="mi" aria-hidden="true">ğŸ”¥</span><div class="mn">Blitz 3min</div><div class="md">Velocidad creciente</div></div>
    </div>
  </div>

  <div class="l-ctas">
    <button class="btn" onclick="UI.play()" aria-label="Iniciar juego">Jugar ahora</button>
    <button class="btn ghost" onclick="UI.openManual()" aria-label="Abrir manual">ğŸ“– &nbsp; CÃ³mo se juega</button>
  </div>

  <footer class="l-foot">
    <div class="lf1">Un juego de <a href="https://www.explicalia.com" target="_blank" rel="noopener">explicalia.com</a></div>
    <div class="lf2">Â© 2025 Explicalia System Â· Todos los derechos reservados</div>
  </footer>

</div>
```

  </div>
</div>

<!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘  SCREEN 2 â€” MANUAL              â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="scr" id="s2" role="dialog" aria-label="Manual de juego">
  <div class="m-sheet">
    <div class="mh"></div>
    <div class="mhd">
      <div class="mhd-t">Manual de juego</div>
      <button class="mhd-x" onclick="UI.closeManual()" aria-label="Cerrar manual">âœ•</button>
    </div>
    <div class="mb">
      <div class="mhero">
        <div class="mhero-t">Tetris Â· Explicalia</div>
        <div class="mhero-s">Siete piezas. Infinitas decisiones.<br>Todo lo que necesitas dominar.</div>
      </div>

```
  <div class="msec">
    <div class="slbl">Controles â€” Gestos sobre el tablero</div>
    <div class="mcard">
      <div class="mrow"><div class="mico" style="background:rgba(0,122,255,.14)">â†â†’</div>
        <div class="mtxt"><h4>Deslizar izquierda / derecha</h4>
        <p>Mueve la pieza. MantÃ©n pulsado para repeticiÃ³n automÃ¡tica (DAS 185ms, ARR 58ms).</p></div></div>
      <div class="mrow"><div class="mico" style="background:rgba(0,122,255,.14)">â†“</div>
        <div class="mtxt"><h4>Deslizar suave hacia abajo</h4>
        <p>Soft drop: cae mÃ¡s rÃ¡pido. +1 punto por celda recorrida.</p></div></div>
      <div class="mrow"><div class="mico" style="background:rgba(255,208,0,.12)">â¬‡</div>
        <div class="mtxt"><h4>Flick rÃ¡pido hacia abajo</h4>
        <p>Hard drop instantÃ¡neo. +2 pts por celda. La jugada mÃ¡s eficiente.</p></div></div>
      <div class="mrow"><div class="mico" style="background:rgba(175,82,222,.14)">â†‘</div>
        <div class="mtxt"><h4>Flick hacia arriba</h4>
        <p>HOLD: guarda la pieza para usarla despuÃ©s. Solo una vez por turno.</p></div></div>
      <div class="mrow"><div class="mico" style="background:rgba(90,200,250,.14)">â—€</div>
        <div class="mtxt"><h4>Toque mitad izquierda del tablero</h4>
        <p>Rota la pieza en sentido antihorario (CCW).</p></div></div>
      <div class="mrow"><div class="mico" style="background:rgba(90,200,250,.14)">â–¶</div>
        <div class="mtxt"><h4>Toque mitad derecha del tablero</h4>
        <p>Rota la pieza en sentido horario (CW). Sistema SRS oficial con wall kicks.</p></div></div>
    </div>
  </div>

  <div class="msec">
    <div class="slbl">MecÃ¡nicas avanzadas</div>
    <div class="mcard">
      <div class="mrow"><div class="mico" style="background:rgba(255,255,255,.05)">ğŸ‘»</div>
        <div class="mtxt"><h4>Ghost piece</h4>
        <p>Silueta transparente que muestra dÃ³nde caerÃ¡ la pieza. Imprescindible para jugar rÃ¡pido.</p></div></div>
      <div class="mrow"><div class="mico" style="background:rgba(255,59,48,.1)">â³</div>
        <div class="mtxt"><h4>Lock Delay (500ms + parpadeo)</h4>
        <p>Al tocar el suelo tienes 500ms para reposicionar. La pieza parpadea. Cada movimiento reinicia el contador (mÃ¡x. 15 veces).</p></div></div>
      <div class="mrow"><div class="mico" style="background:rgba(52,199,89,.12)">ğŸ”„</div>
        <div class="mtxt"><h4>Sistema SRS completo</h4>
        <p>5 wall kicks por rotaciÃ³n. Las piezas se adaptan a espacios estrechos cerca de paredes.</p></div></div>
      <div class="mrow"><div class="mico" style="background:rgba(255,204,0,.1)">ğŸŒ€</div>
        <div class="mtxt"><h4>T-Spin</h4>
        <p>Rota la T en un hueco cerrado. La jugada mÃ¡s premium â€” multiplica puntuaciÃ³n drÃ¡sticamente.</p></div></div>
      <div class="mrow"><div class="mico" style="background:rgba(0,212,232,.1)">ğŸ”—</div>
        <div class="mtxt"><h4>Back-to-Back +50%</h4>
        <p>Encadena Tetris o T-Spins consecutivos para un bono permanente del 50%.</p></div></div>
    </div>
  </div>

  <div class="msec">
    <div class="slbl">Tabla de puntuaciÃ³n oficial</div>
    <div class="stbl">
      <div class="srow"><span class="sn">Single â€” 1 lÃ­nea</span><span class="sp">100 Ã— nivel</span></div>
      <div class="srow"><span class="sn">Double â€” 2 lÃ­neas</span><span class="sp">300 Ã— nivel</span></div>
      <div class="srow"><span class="sn">Triple â€” 3 lÃ­neas</span><span class="sp">500 Ã— nivel</span></div>
      <div class="srow"><span class="sn">âš¡ Tetris â€” 4 lÃ­neas</span><span class="sp">800 Ã— nivel</span></div>
      <div class="srow"><span class="sn">ğŸŒ€ T-Spin Single</span><span class="sp">800 Ã— nivel</span></div>
      <div class="srow"><span class="sn">ğŸŒ€ T-Spin Double</span><span class="sp">1 200 Ã— nivel</span></div>
      <div class="srow"><span class="sn">âœ¨ All Clear</span><span class="sp">3 500 Ã— nivel</span></div>
      <div class="srow"><span class="sn">ğŸ”— Back-to-Back</span><span class="sp">Ã—1.5 puntos</span></div>
      <div class="srow"><span class="sn">ğŸ’¥ Combo (Ã—n)</span><span class="sp">50 Ã— combo Ã— nivel</span></div>
    </div>
  </div>

  <div class="msec">
    <div class="slbl">Estrategia pro</div>
    <div class="tip"><div class="tii" aria-hidden="true">ğŸ¯</div>
      <p><strong>Pila plana siempre.</strong> Evita torres y columnas aisladas. Superficie uniforme = mÃ¡s opciones.</p></div>
    <div class="tip"><div class="tii" aria-hidden="true">ğŸ“¦</div>
      <p><strong>Hold = seguro de vida.</strong> Guarda la S o Z cuando no encajan. Ãšsalas en el momento exacto.</p></div>
    <div class="tip"><div class="tii" aria-hidden="true">ğŸ”µ</div>
      <p><strong>7-Bag garantizado.</strong> Cada pieza aparece exactamente una vez cada 7. Planifica la I.</p></div>
    <div class="tip" style="background:rgba(175,82,222,.09);border-color:rgba(175,82,222,.2)">
      <div class="tii" aria-hidden="true">ğŸŒ€</div>
      <p><strong>T-Spin supera a Tetris.</strong> Un T-Spin Double en nivel 10 vale mÃ¡s que un Tetris en nivel 5.</p></div>
  </div>

  <div style="text-align:center;padding:6px 0 4px;">
    <div style="font-size:.55rem;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,.12);">
      DiseÃ±ado por <a href="https://www.explicalia.com" style="color:rgba(255,255,255,.22);text-decoration:none;font-weight:600;" target="_blank" rel="noopener">Explicalia System</a>
    </div>
  </div>
</div>
<div class="mf">
  <button class="btn" onclick="UI.playFromManual()">Empezar a jugar</button>
</div>
```

  </div>
</div>

<!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘  SCREEN 3 â€” GAME                â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="scr" id="s3" role="application" aria-label="Tetris">
  <div id="hud">
    <div class="hp" id="hsc"><div class="hp-l">Puntos</div><div class="hp-v" id="hv-sc">0</div></div>
    <div class="hp" id="hli"><div class="hp-l">LÃ­neas</div><div class="hp-v" id="hv-li">0</div></div>
    <div class="hp" id="hlv"><div class="hp-l" id="hv-lbl">Nivel</div><div class="hp-v" id="hv-lv">1</div></div>
    <div class="hp" id="hhi"><div class="hp-l">RÃ©cord</div><div class="hp-v" id="hv-hi">0</div></div>
    <button class="hpb" onclick="G&&G.pause()" aria-label="Pausar">â¸</button>
  </div>

  <div id="gmain">
    <div class="gside">
      <div class="gbox">
        <div class="gbl">HOLD</div>
        <canvas class="gcv" id="cv-h" width="46" height="36" aria-label="Pieza guardada"></canvas>
      </div>
    </div>
    <div id="bwrap">
      <div id="board">
        <canvas id="gcvs" aria-label="Tablero de juego"></canvas>
      </div>
    </div>
    <div class="gside">
      <div class="gbox" style="height:auto;padding-bottom:7px;">
        <div class="gbl" style="margin-bottom:3px;">NEXT</div>
        <canvas class="gcv" id="cv-n" width="46" height="210" aria-label="PrÃ³ximas piezas"></canvas>
      </div>
    </div>
  </div>

  <div id="gctrl">
    <div class="crow">
      <button class="gb gb-hl" id="bt-hl" aria-label="Guardar pieza">HOLD</button>
      <button class="gb gb-rl" id="bt-rl" aria-label="Rotar izquierda">â†º</button>
      <button class="gb gb-rr" id="bt-rr" aria-label="Rotar derecha">â†»</button>
      <button class="gb gb-hd" id="bt-hd" aria-label="CaÃ­da instantÃ¡nea">â¬‡</button>
      <button class="gb gb-le" id="bt-le" aria-label="Mover izquierda">â†</button>
      <button class="gb gb-dn" id="bt-dn" aria-label="CaÃ­da suave">â†“</button>
      <button class="gb gb-ri" id="bt-ri" aria-label="Mover derecha">â†’</button>
    </div>
    <div class="crow">
      <button class="gb gb-ps" onclick="G&&G.pause()" aria-label="Pausar juego">â¸ &nbsp; PAUSA</button>
    </div>
    <div class="hint" aria-hidden="true">desliza tablero Â· toca izq/der para rotar Â· flick rÃ¡pido = hard drop</div>
  </div>
</div>

<!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘  SCREEN 4 â€” PAUSE               â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="scr" id="s4" role="dialog" aria-label="Pausa">
  <div class="pcard">
    <div class="pt">Pausa</div>
    <div class="ps-w">
      <div class="ps-l">PuntuaciÃ³n actual</div>
      <div class="ps-v" id="ps-v">0</div>
    </div>
    <button class="pr" onclick="G&&G.resume()">â–¶ &nbsp; Continuar</button>
    <button class="pq" onclick="UI.quitFarewell()">Salir del juego</button>
  </div>
</div>

<!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘  SCREEN 5 â€” GAME OVER           â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="scr" id="s5" role="status" aria-label="Fin del juego">
  <div class="sw">
    <div class="go-w">
      <div class="go-e" id="go-e" aria-hidden="true">ğŸ’€</div>
      <div class="go-t">GAME<br>OVER</div>
      <div class="go-q" id="go-q"></div>
      <div class="go-sb">
        <div class="gl">PuntuaciÃ³n final</div>
        <div class="gv" id="go-sc">0</div>
      </div>
      <div id="nrec" aria-live="polite">âœ¦ &nbsp; NUEVO RÃ‰CORD &nbsp; âœ¦</div>
      <div class="go-st">
        <div class="go-s"><div class="go-sl">LÃ­neas</div><div class="go-sv" id="go-li" style="color:var(--green)">0</div></div>
        <div class="go-s"><div class="go-sl">Nivel</div><div class="go-sv" id="go-lv" style="color:var(--yellow)">1</div></div>
        <div class="go-s"><div class="go-sl">RÃ©cord</div><div class="go-sv" id="go-hi" style="color:var(--orange)">0</div></div>
      </div>
      <div class="go-ct">
        <button class="btn red" onclick="UI.retry()">Jugar de nuevo</button>
        <button class="btn ghost" onclick="UI.farewell()">Volver al menÃº</button>
      </div>
    </div>
  </div>
</div>

<!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘  SCREEN 6 â€” FAREWELL            â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="scr" id="s6">
  <div class="sw">
    <div class="fw-w">
      <div class="fw-e" id="fw-e" aria-hidden="true">ğŸ‘‹</div>
      <div class="fw-t">Hasta la prÃ³xima</div>
      <div class="fw-q" id="fw-q"></div>
      <div class="fw-hb">
        <div class="fw-hl">Tu mejor puntuaciÃ³n histÃ³rica</div>
        <div class="fw-hv" id="fw-hi">â€”</div>
      </div>
      <div class="fw-ct">
        <button class="btn green" onclick="UI.play()">Jugar otra vez</button>
        <button class="btn ghost" onclick="UI.toLanding()">Volver al inicio</button>
      </div>
      <div class="fw-cr">
        <div class="fw-c1">Una experiencia de <a href="https://www.explicalia.com" target="_blank" rel="noopener">explicalia.com</a></div>
        <div class="fw-c2">Â© 2025 Explicalia System</div>
      </div>
    </div>
  </div>
</div>

</div><!-- /#app -->

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TETRIS Â· EXPLICALIA â€” Engine v5.0 (Production)
   All bugs fixed, performance optimized,
   comprehensive error handling.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const COLS = 10, ROWS = 20;

/* â”€â”€ Piece definitions â”€â”€ */
const SHP = {
  I: { s: [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]] },
  O: { s: [[1,1],[1,1]] },
  T: { s: [[0,1,0],[1,1,1],[0,0,0]] },
  S: { s: [[0,1,1],[1,1,0],[0,0,0]] },
  Z: { s: [[1,1,0],[0,1,1],[0,0,0]] },
  J: { s: [[1,0,0],[1,1,1],[0,0,0]] },
  L: { s: [[0,0,1],[1,1,1],[0,0,0]] }
};

const PC = { I:'#00d4e8', O:'#ffd000', T:'#b44fdb', S:'#2ed158', Z:'#ff3b30', J:'#0a7cff', L:'#ff9f0a' };
const PG = {
  I:'rgba(0,212,232,.7)',  O:'rgba(255,208,0,.7)',  T:'rgba(180,79,219,.7)',
  S:'rgba(46,209,88,.7)',  Z:'rgba(255,59,48,.7)',  J:'rgba(10,124,255,.7)', L:'rgba(255,159,10,.7)'
};

/* SRS wall kick data */
const KN = [
  [[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]], [[0,0],[1,0],[1,-1],[0,2],[1,2]],
  [[0,0],[1,0],[1,1],[0,-2],[1,-2]],     [[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]
];
const KI = [
  [[0,0],[-2,0],[1,0],[-2,-1],[1,2]], [[0,0],[-1,0],[2,0],[-1,2],[2,-1]],
  [[0,0],[2,0],[-1,0],[2,1],[-1,-2]], [[0,0],[1,0],[-2,0],[1,-2],[-2,1]]
];

/* Gravity values per level (ms per drop) */
const GV = [800, 720, 630, 550, 470, 380, 300, 220, 150, 100, 80, 70, 60, 55, 50];

/* Sarcasm banks */
const GO_B = [
  { e:'ğŸ’€', q:'Al menos caÃ­ste con estilo. Buenoâ€¦ casi.' },
  { e:'ğŸ¤¦', q:'Llevas mÃ¡s tiempo mirando la pantalla que jugando.' },
  { e:'ğŸ˜¬', q:'Eso fueâ€¦ algo. Definitivamente fue algo.' },
  { e:'ğŸ« ', q:'Tu pila de bloques te mandÃ³ sus condolencias.' },
  { e:'ğŸ˜…', q:'Tranquilo. Las piezas tambiÃ©n se rinden a veces.' },
  { e:'ğŸ§±', q:'Construiste una obra de arte. Solo que al revÃ©s.' },
  { e:'ğŸ®', q:'Tetris te mandÃ³ un tutorial. De regalo.' },
  { e:'â˜•', q:'QuizÃ¡s un cafÃ© ayude. Probablemente no.' },
  { e:'ğŸ†', q:'RÃ©cord personal. De peor puntuaciÃ³n, pero rÃ©cord.' },
  { e:'ğŸ­', q:'Con ese juego no abras un canal de gaming.' }
];
const FW_B = [
  { e:'ğŸ‘‹', q:'Salir ahora fue la decisiÃ³n mÃ¡s valiente del dÃ­a. Tu pila te lo agradece.' },
  { e:'ğŸ›‹', q:'Los bloques seguirÃ¡n aquÃ­ cuando vuelvas. Ellos no tienen adÃ³nde ir.' },
  { e:'ğŸ«¡', q:'Â¿Ya te vas? La pieza I acababa de llegar. TÃ­pico.' },
  { e:'ğŸ­', q:'Hasta pronto. El tablero te guardarÃ¡ el sitio. Aunque ojalÃ¡ no lo necesites.' },
  { e:'ğŸš¶', q:'Salir a tiempo tambiÃ©n es una habilidad. LÃ¡stima que dentro del juego no la tienes.' }
];

/* â”€â”€ Storage with error handling â”€â”€ */
const DB = {
  _get(k) {
    try { return localStorage.getItem(k); }
    catch(e) { return null; }
  },
  _set(k, v) {
    try { localStorage.setItem(k, v); }
    catch(e) { /* quota exceeded or private mode */ }
  },
  hi()   { return parseInt(this._get('ex_hi') || '0'); },
  gm()   { return parseInt(this._get('ex_gm') || '0'); },
  li()   { return parseInt(this._get('ex_li') || '0'); },
  save(sc, li) {
    if (sc > this.hi()) this._set('ex_hi', sc);
    this._set('ex_gm', this.gm() + 1);
    this._set('ex_li', this.li() + li);
  }
};

/* â”€â”€ Logo build â”€â”€ */
(function() {
  const T = [[1,1,1],[0,1,0],[0,1,0]];
  const cols = Object.values(PC);
  const g = document.getElementById('lgrid');
  if (!g) return;
  T.forEach((row, r) => row.forEach((v, c) => {
    const el = document.createElement('div');
    el.className = 'lc';
    el.style.background = v ? cols[(r * 3 + c) % cols.length] : 'transparent';
    g.appendChild(el);
  }));
})();

/* â”€â”€ Rain (landing bg) â”€â”€ */
const rainCvs = document.getElementById('rain');
const rainX = rainCvs ? rainCvs.getContext('2d') : null;
let rainOn = true;

function resizeRain() {
  if (!rainCvs) return;
  rainCvs.width = window.innerWidth;
  rainCvs.height = window.innerHeight;
}
resizeRain();
window.addEventListener('resize', resizeRain);

const DROPS = (() => {
  const ps = Object.values(SHP), cs = Object.values(PC);
  return Array.from({ length: 12 }, () => ({
    p: ps[0 | Math.random() * ps.length],
    x: Math.random() * window.innerWidth,
    y: Math.random() * window.innerHeight - window.innerHeight,
    spd: .22 + Math.random() * .48,
    rot: Math.random() * 360,
    col: cs[0 | Math.random() * cs.length],
    sz: 9 + Math.random() * 5
  }));
})();

(function rl() {
  if (rainOn && rainX) {
    rainX.clearRect(0, 0, rainCvs.width, rainCvs.height);
    DROPS.forEach(d => {
      d.y += d.spd;
      d.rot += .22;
      if (d.y > rainCvs.height + 60) { d.y = -70; d.x = Math.random() * rainCvs.width; }
      rainX.save();
      rainX.translate(d.x, d.y);
      rainX.rotate(d.rot * Math.PI / 180);
      rainX.globalAlpha = .1;
      d.p.s.forEach((row, ry) => row.forEach((v, cx) => {
        if (!v) return;
        rainX.fillStyle = d.col;
        rainX.fillRect(
          cx * d.sz - d.p.s[0].length * d.sz * .5,
          ry * d.sz - d.p.s.length * d.sz * .5,
          d.sz - 1, d.sz - 1
        );
      }));
      rainX.restore();
    });
  }
  requestAnimationFrame(rl);
})();

/* â”€â”€ Screen router â”€â”€ */
let CUR = 's1';
function go(id) {
  const prev = document.getElementById(CUR);
  const next = document.getElementById(id);
  if (prev) prev.classList.remove('on');
  if (next) next.classList.add('on');
  CUR = id;
  const sw = next ? next.querySelector('.sw') : null;
  if (sw) sw.scrollTop = 0;
}

/* â”€â”€ Landing stats â”€â”€ */
function refreshLanding() {
  const h = DB.hi(), g = DB.gm(), l = DB.li();
  const hi = document.getElementById('l-hi');
  const gm = document.getElementById('l-gm');
  const li = document.getElementById('l-li');
  if (hi) hi.textContent = h > 0 ? h.toLocaleString() : 'â€”';
  if (gm) gm.textContent = g > 0 ? g.toLocaleString() : 'â€”';
  if (li) li.textContent = l > 0 ? l.toLocaleString() : 'â€”';
}
refreshLanding();

/* â”€â”€ UI controller â”€â”€ */
let MODE = 'marathon';
const UI = {
  mode(el, m) {
    document.querySelectorAll('.mc').forEach(c => {
      c.classList.remove('on');
      c.setAttribute('aria-checked', 'false');
    });
    el.classList.add('on');
    el.setAttribute('aria-checked', 'true');
    MODE = m;
  },
  play() {
    rainOn = false;
    go('s3');
    requestWakeLock();
    setTimeout(() => { resizeBoard(); G.start(); }, 60);
  },
  openManual() { go('s2'); },
  closeManual() { go('s1'); },
  playFromManual() {
    rainOn = false;
    go('s3');
    requestWakeLock();
    setTimeout(() => { resizeBoard(); G.start(); }, 60);
  },
  retry() {
    go('s3');
    requestWakeLock();
    setTimeout(() => { resizeBoard(); G.start(); }, 60);
  },
  quitFarewell() {
    if (G) { G.running = false; if (G.raf) cancelAnimationFrame(G.raf); }
    releaseWakeLock();
    this._fw();
  },
  farewell() { releaseWakeLock(); this._fw(); },
  _fw() {
    const fw = FW_B[0 | Math.random() * FW_B.length];
    const fwE = document.getElementById('fw-e');
    const fwQ = document.getElementById('fw-q');
    const fwH = document.getElementById('fw-hi');
    if (fwE) fwE.textContent = fw.e;
    if (fwQ) fwQ.textContent = fw.q;
    const h = DB.hi();
    if (fwH) fwH.textContent = h > 0 ? h.toLocaleString() : 'â€”';
    go('s6');
  },
  toLanding() { rainOn = true; refreshLanding(); go('s1'); }
};

/* â”€â”€ Wake Lock (prevent screen sleep) â”€â”€ */
let wakeLock = null;
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', () => { wakeLock = null; });
    }
  } catch(e) { /* not supported or denied */ }
}
function releaseWakeLock() {
  try { if (wakeLock) { wakeLock.release(); wakeLock = null; } }
  catch(e) {}
}

/* â”€â”€ Canvas refs â”€â”€ */
const gCvs = document.getElementById('gcvs');
const gCtx = gCvs ? gCvs.getContext('2d') : null;
const hCvs = document.getElementById('cv-h');
const hCtx = hCvs ? hCvs.getContext('2d') : null;
const nCvs = document.getElementById('cv-n');
const nCtx = nCvs ? nCvs.getContext('2d') : null;
let CELL = 28;

function resizeBoard() {
  if (!gCvs || !gCtx) return;
  const hudEl = document.getElementById('hud');
  const ctrlEl = document.getElementById('gctrl');
  const sideEl = document.querySelector('.gside');
  if (!hudEl || !ctrlEl) return;

  const hud = hudEl.getBoundingClientRect();
  const ctrl = ctrlEl.getBoundingClientRect();
  const sideW = sideEl ? sideEl.getBoundingClientRect().width : 50;
  const W = window.innerWidth, H = window.innerHeight;
  const availH = H - hud.height - ctrl.height - 14;
  const availW = W - (sideW + 5) * 2 - 18;
  const cH = Math.floor(availH / ROWS), cW = Math.floor(availW / COLS);
  CELL = Math.max(12, Math.min(cH, cW));

  gCvs.width = CELL * COLS;
  gCvs.height = CELL * ROWS;

  const b = document.getElementById('board');
  if (b) {
    b.style.width = gCvs.width + 'px';
    b.style.height = gCvs.height + 'px';
  }

  if (nCvs) nCvs.height = Math.min(CELL * 13 + 20, 220);
  if (G && G.piece) { G.draw(); G.sides(); }
}

window.addEventListener('resize', () => {
  if (CUR === 's3') resizeBoard();
});

/* â”€â”€ Colour helpers â”€â”€ */
function adj(hex, a) {
  const n = parseInt(hex.slice(1), 16);
  const r = Math.min(255, Math.max(0, ((n >> 16) & 255) + Math.round(a * 255)));
  const g = Math.min(255, Math.max(0, ((n >> 8) & 255) + Math.round(a * 255)));
  const b = Math.min(255, Math.max(0, (n & 255) + Math.round(a * 255)));
  return `rgb(${r},${g},${b})`;
}

/* â”€â”€ Audio System â”€â”€ */
class SFX {
  constructor() { this.a = null; }
  init() {
    if (this.a) return;
    try { this.a = new (window.AudioContext || window.webkitAudioContext)(); }
    catch(e) {}
  }
  _t(f, t, d, v = .07) {
    if (!this.a) return;
    try {
      if (this.a.state === 'suspended') this.a.resume();
      const o = this.a.createOscillator(), g = this.a.createGain();
      o.type = t; o.frequency.value = f;
      g.gain.setValueAtTime(v, this.a.currentTime);
      g.gain.exponentialRampToValueAtTime(.001, this.a.currentTime + d);
      o.connect(g); g.connect(this.a.destination);
      o.start(); o.stop(this.a.currentTime + d);
    } catch(e) {}
  }
  move()   { this._t(260, 'sine', .04, .05); }
  rotate() { this._t(480, 'triangle', .06, .07); }
  lock()   { this._t(180, 'sine', .06, .09); }
  hold()   { this._t(360, 'sine', .09, .09); }
  clear(n) { [523,659,784,1047].slice(0, n).forEach((f, i) => setTimeout(() => this._t(f, 'sine', .2, .13), i * 55)); }
  tspin()  { [659,880,1047].forEach((f, i) => setTimeout(() => this._t(f, 'square', .12, .1), i * 45)); }
  allcl()  { [523,659,784,1047,1319].forEach((f, i) => setTimeout(() => this._t(f, 'sine', .25, .15), i * 70)); }
  over()   { [400,350,300,250,200].forEach((f, i) => setTimeout(() => this._t(f, 'sawtooth', .35, .12), i * 110)); }
  lvlup()  { [784,880,1047].forEach((f, i) => setTimeout(() => this._t(f, 'sine', .18, .18), i * 90)); }
  combo(n) { this._t(200 + n * 50, 'triangle', .09, .11); }
}

function hap(d = 7) {
  try { if (navigator.vibrate) navigator.vibrate(d); } catch(e) {}
}

/* â”€â”€ Matrix utils â”€â”€ */
const rot90 = m => m[0].map((_, i) => m.map(r => r[i]).reverse());
const dc = m => JSON.parse(JSON.stringify(m));

function makeBag() {
  const k = [...Object.keys(SHP)];
  for (let i = k.length - 1; i > 0; i--) {
    const j = 0 | Math.random() * (i + 1);
    [k[i], k[j]] = [k[j], k[i]];
  }
  return k;
}

/* Score animation helper */
function animateScore(el) {
  if (!el) return;
  el.classList.remove('score-pop');
  void el.offsetWidth; // force reflow
  el.classList.add('score-pop');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TETRIS ENGINE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
class Engine {
  constructor() {
    this.sfx = new SFX();
    this.hi = DB.hi();
    this.running = false;
    this.raf = null;
    this._input();
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && this.running && !this.paused_ && !this.over_) this.pause();
    });
  }

  start() {
    this.sfx.init();
    this.running = true;
    this.over_ = false;
    this.paused_ = false;
    this.board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
    this.sc = 0; this.li = 0; this.lv = 1;
    this.combo = -1; this.btb = false;
    this.bag = []; this.q = [];
    this.hold_ = null; this.canHold = true;
    this.ts = 0; this.dropA = 0;
    this.lockA = 0; this.lockM = 0; this.lockOn = false;
    this.tspin_ = null;
    this.mode_ = MODE;
    this.modeT = 0;
    this.blitzLv = 1; // for blitz speed increase
    this._fillQ(); this._spawn(); this._ui(); this._modeLbl();
    go('s3'); CUR = 's3';
    if (this.raf) cancelAnimationFrame(this.raf);
    this.raf = requestAnimationFrame(this._loop.bind(this));
  }

  _modeLbl() {
    const lbl = document.getElementById('hv-lbl');
    if (lbl) lbl.textContent = (this.mode_ === 'ultra' || this.mode_ === 'blitz') ? 'Tiempo' : 'Nivel';
  }

  _fillQ() {
    while (this.q.length < 5) {
      if (!this.bag.length) this.bag = makeBag();
      const k = this.bag.pop();
      this.q.push({ t: k, s: dc(SHP[k].s) });
    }
    this._dNext();
  }

  _spawn() {
    const n = this.q.shift();
    this._fillQ();
    const s = dc(SHP[n.t].s);
    this.piece = { t: n.t, s, r: 0, x: n.t === 'O' ? 4 : 3, y: n.t === 'I' ? -1 : 0 };
    this.tspin_ = null;
    this.lockOn = false;
    this.lockA = 0;
    this.lockM = 0;
    if (this._col(this.board, this.piece)) { this._end(); return; }
    this.canHold = true;
    this.draw();
    this.sides();
  }

  _col(b, p) {
    for (let r = 0; r < p.s.length; r++) {
      for (let c = 0; c < p.s[r].length; c++) {
        if (!p.s[r][c]) continue;
        const nr = r + p.y, nc = c + p.x;
        if (nc < 0 || nc >= COLS || nr >= ROWS) return true;
        if (nr >= 0 && b[nr][nc]) return true;
      }
    }
    return false;
  }

  _merge() {
    this.piece.s.forEach((row, r) => row.forEach((v, c) => {
      if (v) {
        const pr = r + this.piece.y, pc = c + this.piece.x;
        if (pr >= 0 && pr < ROWS && pc >= 0 && pc < COLS) {
          this.board[pr][pc] = this.piece.t;
        }
      }
    }));
  }

  tryRot(dir) {
    const nr = ((this.piece.r + dir + 4) % 4);
    const ns = dir > 0 ? rot90(this.piece.s) : rot90(rot90(rot90(this.piece.s)));
    const kicks = this.piece.t === 'I' ? KI : KN;
    for (const [kx, ky] of kicks[this.piece.r]) {
      const t = { ...this.piece, s: ns, r: nr, x: this.piece.x + kx, y: this.piece.y - ky };
      if (!this._col(this.board, t)) {
        this.piece = { ...t };
        if (this.piece.t === 'T') this._cts();
        this.sfx.rotate(); hap(4);
        if (this.lockOn) this._rlock();
        this.draw();
        return true;
      }
    }
    return false;
  }

  _cts() {
    const co = [[0,0],[0,2],[2,0],[2,2]];
    let fl = 0;
    co.forEach(([r, c]) => {
      const br = this.piece.y + r, bc = this.piece.x + c;
      if (br < 0 || br >= ROWS || bc < 0 || bc >= COLS || (this.board[br] && this.board[br][bc])) fl++;
    });
    if (fl < 3) { this.tspin_ = null; return; }
    const fi = this.piece.r === 0 ? [0,1] : this.piece.r === 1 ? [1,3] : this.piece.r === 2 ? [2,3] : [0,2];
    let ff = 0;
    fi.forEach(i => {
      const [r, c] = co[i];
      const br = this.piece.y + r, bc = this.piece.x + c;
      if (br < 0 || br >= ROWS || bc < 0 || bc >= COLS || (this.board[br] && this.board[br][bc])) ff++;
    });
    this.tspin_ = ff === 2 ? 'n' : 'm';
  }

  move(dx) {
    this.piece.x += dx;
    if (this._col(this.board, this.piece)) { this.piece.x -= dx; return false; }
    this.sfx.move(); hap(3); this.tspin_ = null;
    if (this.lockOn) this._rlock();
    this.draw();
    return true;
  }

  softDrop() {
    this.piece.y++;
    if (this._col(this.board, this.piece)) { this.piece.y--; this._lock(); return; }
    this.sc += 1; this.dropA = 0; this.draw();
  }

  hardDrop() {
    let d = 0;
    while (!this._col(this.board, { ...this.piece, y: this.piece.y + 1 })) { this.piece.y++; d++; }
    this.sc += d * 2; hap(14); this._lock();
  }

  _lock() {
    if (this.over_) return;
    this._merge(); this.sfx.lock(); hap(7);
    this.lockOn = false; this._sweep();
  }

  _rlock() {
    if (this.lockM < 15) { this.lockA = 0; this.lockM++; }
  }

  _sweep() {
    const rows = [];
    for (let r = ROWS - 1; r >= 0; r--) {
      if (this.board[r].every(v => v)) rows.push(r);
    }
    const n = rows.length;

    if (n > 0) {
      this._flash(rows, () => {
        rows.forEach(r => {
          this.board.splice(r, 1);
          this.board.unshift(Array(COLS).fill(0));
        });
        this.draw();
      });

      const ts = this.tspin_;
      const PL = [0, 100, 300, 500, 800];
      const PT = [400, 800, 1200, 1600];
      const PM = [100, 200, 400];
      const effectiveLv = this.mode_ === 'blitz' ? this.blitzLv : this.lv;
      let pts = ts === 'n' ? (PT[n] || 0) * effectiveLv : ts === 'm' ? (PM[n] || 0) * effectiveLv : (PL[n] || 0) * effectiveLv;

      const btb = (n === 4) || (ts === 'n' && n > 0);
      if (btb && this.btb) pts = Math.floor(pts * 1.5);
      this.btb = btb;
      this.combo++;

      if (this.combo > 0) { pts += 50 * this.combo * effectiveLv; this.sfx.combo(this.combo); }

      const ac = this.board.every(r => r.every(v => !v));
      if (ac) { pts += 3500 * effectiveLv; this.sfx.allcl(); }

      this.sc += pts;
      this.li += n;

      if (ts === 'n') this.sfx.tspin(); else this.sfx.clear(n);
      hap(n === 4 ? 28 : 12);

      this._fbPts(pts, rows[rows.length - 1]);
      if (this.combo > 1) this._fbEl('fb-combo', `${this.combo}Ã— COMBO!`, '25%');
      if (ts) this._fbEl('fb-tspin', ts === 'n' ? `T-SPIN ${['','SINGLE','DOUBLE','TRIPLE'][n] || ''}` : 'T-SPIN MINI', '40%');
      if (ac) this._fbEl('fb-ac', 'âœ¦ ALL CLEAR âœ¦', '18%');
      this._shake(); this._ptcs();

      // Level up
      const nl = Math.floor(this.li / 10) + 1;
      if (nl > this.lv && this.mode_ !== 'blitz') {
        this.lv = nl; this.sfx.lvlup(); hap(20);
        const lf = document.getElementById('lf');
        if (lf) { lf.classList.add('on'); setTimeout(() => lf.classList.remove('on'), 180); }
        this._fbEl('fb-lv', `NIVEL ${this.lv}`, '30%');
      }

      // Blitz speed increase every 30 seconds
      if (this.mode_ === 'blitz') {
        const newBlitzLv = Math.min(15, Math.floor(this.modeT / 30000) + 1);
        if (newBlitzLv > this.blitzLv) {
          this.blitzLv = newBlitzLv;
          this.sfx.lvlup(); hap(20);
          this._fbEl('fb-lv', `VELOCIDAD ${this.blitzLv}`, '30%');
        }
      }

      if (this.mode_ === 'sprint' && this.li >= 40) this._end();

      animateScore(document.getElementById('hv-sc'));
      this._ui();
    } else {
      this.combo = -1;
      this.tspin_ = null;
    }
    this._spawn();
  }

  _flash(rows, cb) {
    let i = 0;
    const snap = dc(this.board);
    const fl = () => {
      if (i < 6) {
        rows.forEach(r => {
          for (let c = 0; c < COLS; c++) snap[r][c] = i % 2 === 0 ? 'X' : 0;
        });
        this._brd(snap); i++;
        setTimeout(fl, 36);
      } else { cb(); }
    };
    fl();
  }

  _fbPts(pts, row) {
    const w = document.getElementById('bwrap');
    if (!w) return;
    const el = document.createElement('div');
    el.className = 'fb fb-pts';
    el.style.cssText = `color:${pts > 800 ? '#ffd000' : '#fff'};top:${Math.max(5, row / ROWS * 85)}%;left:50%;transform:translateX(-50%);`;
    el.textContent = '+' + pts.toLocaleString();
    w.appendChild(el);
    setTimeout(() => el.remove(), 860);
  }

  _fbEl(cls, text, top) {
    const w = document.getElementById('bwrap');
    if (!w) return;
    const el = document.createElement('div');
    el.className = 'fb ' + cls;
    el.style.top = top;
    el.textContent = text;
    w.appendChild(el);
    setTimeout(() => el.remove(), 1200);
  }

  _shake() {
    const b = document.getElementById('board');
    if (!b) return;
    b.classList.remove('shk');
    void b.offsetWidth;
    b.classList.add('shk');
    setTimeout(() => b.classList.remove('shk'), 300);
  }

  _ptcs() {
    // Skip particles if reduced motion preferred
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
    const r = document.getElementById('board');
    if (!r) return;
    const rect = r.getBoundingClientRect();
    const cx = rect.left + rect.width / 2, cy = rect.top + rect.height / 2;
    const cs = Object.values(PC);
    for (let i = 0; i < 18; i++) {
      const p = document.createElement('div');
      const px = (Math.random() - .5) * 200, py = (Math.random() - .5) * 200;
      p.className = 'ptc';
      p.style.cssText = `width:5px;height:5px;background:${cs[0 | Math.random() * cs.length]};left:${cx}px;top:${cy}px;--px:${px}px;--py:${py}px;`;
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 720);
    }
  }

  hold() {
    if (!this.canHold) return;
    const cur = this.piece.t;
    if (this.hold_) {
      const old = this.hold_;
      this.hold_ = cur;
      this.piece = { t: old, s: dc(SHP[old].s), r: 0, x: old === 'O' ? 4 : 3, y: old === 'I' ? -1 : 0 };
    } else {
      this.hold_ = cur;
      this._spawn();
    }
    this.canHold = false;
    this.sfx.hold(); hap(10);
    this.sides(); this.draw();
  }

  pause() {
    if (this.over_) return;
    this.paused_ = true;
    if (this.raf) cancelAnimationFrame(this.raf);
    const psv = document.getElementById('ps-v');
    if (psv) psv.textContent = this.sc.toLocaleString();
    go('s4');
  }

  resume() {
    this.paused_ = false;
    this.ts = performance.now();
    go('s3'); CUR = 's3';
    this.raf = requestAnimationFrame(this._loop.bind(this));
  }

  _end() {
    this.over_ = true;
    this.running = false;
    if (this.raf) cancelAnimationFrame(this.raf);
    this.sfx.over(); hap(45);
    releaseWakeLock();

    const newHi = this.sc > this.hi;
    if (newHi) this.hi = this.sc;
    DB.save(this.sc, this.li);
    this.hi = DB.hi();

    const q = GO_B[0 | Math.random() * GO_B.length];
    const goE = document.getElementById('go-e');
    const goQ = document.getElementById('go-q');
    const goSc = document.getElementById('go-sc');
    const goLi = document.getElementById('go-li');
    const goLv = document.getElementById('go-lv');
    const goHi = document.getElementById('go-hi');
    const nrec = document.getElementById('nrec');

    if (goE) goE.textContent = q.e;
    if (goQ) goQ.textContent = q.q;
    if (goSc) goSc.textContent = this.sc.toLocaleString();
    if (goLi) goLi.textContent = this.li;
    if (goLv) goLv.textContent = this.lv;
    if (goHi) goHi.textContent = this.hi.toLocaleString();
    if (nrec) nrec.style.display = newHi ? 'block' : 'none';

    refreshLanding();
    setTimeout(() => go('s5'), 650);
  }

  _loop(ts) {
    if (!this.running || this.paused_ || this.over_) return;
    const dt = Math.min(ts - (this.ts || ts), 50);
    this.ts = ts;

    // Timed modes
    if (this.mode_ === 'ultra' || this.mode_ === 'blitz') {
      this.modeT += dt;
      const max = this.mode_ === 'ultra' ? 120000 : 180000;
      const rem = Math.max(0, max - this.modeT);
      const s = Math.ceil(rem / 1000);
      const lvEl = document.getElementById('hv-lv');
      if (lvEl) lvEl.textContent = Math.floor(s / 60) + ':' + String(s % 60).padStart(2, '0');
      if (rem <= 0) { this._end(); return; }
    }

    // Gravity (blitz uses increasing speed)
    const gravLevel = this.mode_ === 'blitz' ? this.blitzLv : this.lv;
    const grav = GV[Math.min(gravLevel - 1, GV.length - 1)];
    this.dropA += dt;

    if (this.dropA > grav) {
      this.dropA -= grav;
      this.piece.y++;
      if (this._col(this.board, this.piece)) {
        this.piece.y--;
        if (!this.lockOn) { this.lockOn = true; this.lockA = 0; }
      }
    }

    if (this.lockOn) {
      this.lockA += dt;
      if (this.lockA > 500) this._lock();
    }

    this.draw();
    this.raf = requestAnimationFrame(this._loop.bind(this));
  }

  _gy() {
    let y = this.piece.y;
    while (!this._col(this.board, { ...this.piece, y: y + 1 })) y++;
    return y;
  }

  _dc(ctx, px, py, type) {
    const s = CELL - 1;
    if (type === 'X') {
      ctx.fillStyle = 'rgba(255,255,255,.88)';
      ctx.fillRect(px, py, s, s);
      return;
    }
    const col = PC[type] || '#888';
    const gl = PG[type] || 'rgba(255,255,255,.5)';
    ctx.shadowColor = gl;
    ctx.shadowBlur = CELL * .5;
    const g = ctx.createLinearGradient(px, py, px, py + s);
    g.addColorStop(0, adj(col, .3));
    g.addColorStop(.5, col);
    g.addColorStop(1, adj(col, -.27));
    ctx.fillStyle = g;
    const rad = Math.max(2, CELL * .1);
    ctx.beginPath(); ctx.roundRect(px + .5, py + .5, s - 1, s - 1, rad); ctx.fill();
    ctx.shadowBlur = 0;
    ctx.fillStyle = 'rgba(255,255,255,.2)';
    ctx.fillRect(px + 2, py + 2, s - 4, Math.max(3, s * .28));
    ctx.strokeStyle = 'rgba(255,255,255,.11)';
    ctx.lineWidth = .5;
    ctx.beginPath(); ctx.roundRect(px + .5, py + .5, s - 1, s - 1, rad); ctx.stroke();
  }

  _brd(board) {
    if (!gCtx || !gCvs) return;
    const w = gCvs.width, h = gCvs.height;
    gCtx.fillStyle = 'rgba(0,0,0,.58)';
    gCtx.fillRect(0, 0, w, h);
    gCtx.strokeStyle = 'rgba(255,255,255,.03)';
    gCtx.lineWidth = .5;
    for (let r = 0; r <= ROWS; r++) { gCtx.beginPath(); gCtx.moveTo(0, r * CELL); gCtx.lineTo(w, r * CELL); gCtx.stroke(); }
    for (let c = 0; c <= COLS; c++) { gCtx.beginPath(); gCtx.moveTo(c * CELL, 0); gCtx.lineTo(c * CELL, h); gCtx.stroke(); }
    board.forEach((row, r) => row.forEach((v, c) => {
      if (v) this._dc(gCtx, c * CELL, r * CELL, v);
    }));
  }

  draw() {
    if (!this.piece || !gCtx) return;
    this._brd(this.board);
    const gy = this._gy();

    // Ghost piece
    this.piece.s.forEach((row, r) => row.forEach((v, c) => {
      if (!v) return;
      const gr = r + gy, gc = c + this.piece.x;
      if (gr >= 0 && gr < ROWS && gc >= 0 && gc < COLS && gr !== (r + this.piece.y)) {
        const s = CELL - 1;
        const rad = Math.max(2, CELL * .1);
        gCtx.strokeStyle = 'rgba(255,255,255,.18)';
        gCtx.lineWidth = 1;
        gCtx.fillStyle = 'rgba(255,255,255,.05)';
        gCtx.beginPath(); gCtx.roundRect(gc * CELL + .5, gr * CELL + .5, s - 1, s - 1, rad);
        gCtx.fill(); gCtx.stroke();
      }
    }));

    // Lock delay blink
    const lp = this.lockOn ? (Math.sin(Date.now() / 75) * .18 + .82) : 1;
    gCtx.globalAlpha = lp;
    this.piece.s.forEach((row, r) => row.forEach((v, c) => {
      if (!v) return;
      const py = r + this.piece.y, px = c + this.piece.x;
      if (py >= 0 && py < ROWS && px >= 0 && px < COLS) {
        this._dc(gCtx, px * CELL, py * CELL, this.piece.t);
      }
    }));
    gCtx.globalAlpha = 1;
  }

  _dMini(ctx, cvs, type) {
    if (!ctx || !cvs) return;
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    if (!type) return;
    const sh = SHP[type].s;
    const cell = Math.floor(Math.min(cvs.width / (sh[0].length + .6), cvs.height / (sh.length + .6)));
    const ox = Math.floor((cvs.width - sh[0].length * cell) / 2);
    const oy = Math.floor((cvs.height - sh.length * cell) / 2);
    sh.forEach((row, r) => row.forEach((v, c) => {
      if (!v) return;
      const px = ox + c * cell, py = oy + r * cell, s = cell - 1;
      const col = PC[type], gl = PG[type];
      ctx.shadowColor = gl; ctx.shadowBlur = 5;
      const g = ctx.createLinearGradient(px, py, px, py + s);
      g.addColorStop(0, adj(col, .3)); g.addColorStop(1, adj(col, -.25));
      ctx.fillStyle = g; ctx.beginPath(); ctx.roundRect(px, py, s, s, 2); ctx.fill();
      ctx.shadowBlur = 0;
    }));
  }

  _dNext() {
    if (!nCtx || !nCvs) return;
    nCtx.clearRect(0, 0, nCvs.width, nCvs.height);
    let oy = 2;
    this.q.slice(0, 4).forEach((item, idx) => {
      const sh = item.s;
      const cell = idx === 0 ? Math.min(Math.floor(nCvs.width / (sh[0].length + .6)), 13) : 9;
      const ox = Math.floor((nCvs.width - sh[0].length * cell) / 2);
      nCtx.globalAlpha = idx === 0 ? 1 : idx === 1 ? .62 : idx === 2 ? .4 : .24;
      sh.forEach((row, r) => row.forEach((v, c) => {
        if (!v) return;
        const px = ox + c * cell, py = oy + r * cell, s = cell - 1;
        const col = PC[item.t], gl = PG[item.t];
        if (idx === 0) { nCtx.shadowColor = gl; nCtx.shadowBlur = 5; }
        const g = nCtx.createLinearGradient(px, py, px, py + s);
        g.addColorStop(0, adj(col, .3)); g.addColorStop(1, adj(col, -.25));
        nCtx.fillStyle = g; nCtx.beginPath(); nCtx.roundRect(px, py, s, s, 2); nCtx.fill();
        nCtx.shadowBlur = 0;
      }));
      nCtx.globalAlpha = 1;
      oy += sh.length * cell + 5;
    });
  }

  sides() { this._dMini(hCtx, hCvs, this.hold_); this._dNext(); }

  _ui() {
    const sc = document.getElementById('hv-sc');
    const li = document.getElementById('hv-li');
    const lv = document.getElementById('hv-lv');
    const hi = document.getElementById('hv-hi');
    if (sc) sc.textContent = this.sc.toLocaleString();
    if (li) li.textContent = this.li;
    if (this.mode_ !== 'ultra' && this.mode_ !== 'blitz' && lv) lv.textContent = this.lv;
    if (hi) hi.textContent = this.hi.toLocaleString();
  }

  /* â”€â”€ INPUT SYSTEM â”€â”€ */
  _input() {
    const bw = document.getElementById('bwrap');
    if (!bw) return;

    let sx, sy, st, drag = false, dDir = null, lastTap = 0, tapTimer = null;

    bw.addEventListener('touchstart', e => {
      e.preventDefault();
      const t = e.touches[0];
      sx = t.clientX; sy = t.clientY; st = Date.now();
      drag = false; dDir = null;
    }, { passive: false });

    bw.addEventListener('touchmove', e => {
      e.preventDefault();
      if (!this.running || this.paused_ || this.over_) return;
      const t = e.touches[0], dx = t.clientX - sx, dy = t.clientY - sy;
      const adx = Math.abs(dx), ady = Math.abs(dy);
      if (!drag && (adx > 10 || ady > 10)) {
        drag = true;
        dDir = adx > ady ? 'h' : 'v';
      }
      if (drag && dDir === 'h') {
        const mv = Math.round(dx / CELL);
        if (mv) { this.move(Math.sign(mv)); sx += Math.sign(mv) * CELL; }
      }
      if (drag && dDir === 'v' && dy > CELL * .6) { this.softDrop(); sy += CELL * .6; }
    }, { passive: false });

    bw.addEventListener('touchend', e => {
      e.preventDefault();
      const now = Date.now();
      const ex = e.changedTouches[0].clientX;
      const ey = e.changedTouches[0].clientY;
      const totalDy = ey - sy, totalTime = now - st;

      // Fast flick down = hard drop
      if (drag && dDir === 'v' && totalDy > CELL * 2.5 && totalTime < 300) {
        if (this.running && !this.paused_) this.hardDrop();
        return;
      }
      // Fast flick up = hold
      if ((sy - ey) > CELL * 1.5 && totalTime < 300) {
        if (this.running && !this.paused_) this.hold();
        return;
      }
      // Tap = rotate (left half CCW, right half CW)
      if (!drag && totalTime < 220) {
        const br = document.getElementById('board');
        if (!br) return;
        const rect = br.getBoundingClientRect();
        const isLeft = ex < rect.left + rect.width / 2;

        // Cancel pending tap timer for double-tap detection
        if (tapTimer) { clearTimeout(tapTimer); tapTimer = null; }

        if (now - lastTap < 280 && lastTap > 0) {
          // Double tap = hard drop
          if (this.running && !this.paused_) this.hardDrop();
          lastTap = 0;
        } else {
          lastTap = now;
          tapTimer = setTimeout(() => {
            if (lastTap === now && this.running && !this.paused_) {
              this.tryRot(isLeft ? -1 : 1);
            }
            tapTimer = null;
          }, 200);
        }
      }
    }, { passive: false });

    // Physical buttons â€” improved DAS/ARR with requestAnimationFrame
    const bind = (id, fn, rep = false) => {
      const btn = document.getElementById(id);
      if (!btn) return;
      let dasTimer, arrTimer, active = false;

      const exec = () => {
        if (this.running && !this.paused_ && !this.over_) { this.sfx.init(); fn(); }
      };

      const startRepeat = () => {
        dasTimer = setTimeout(() => {
          arrTimer = setInterval(exec, 58);
        }, 185);
      };

      btn.addEventListener('pointerdown', e => {
        e.preventDefault();
        active = true;
        exec();
        if (rep) startRepeat();
      });

      const stop = e => {
        if (e) e.preventDefault();
        active = false;
        clearTimeout(dasTimer);
        clearInterval(arrTimer);
      };

      btn.addEventListener('pointerup', stop);
      btn.addEventListener('pointerleave', stop);
      btn.addEventListener('pointercancel', stop);
    };

    bind('bt-le', () => this.move(-1), true);
    bind('bt-ri', () => this.move(1), true);
    bind('bt-dn', () => this.softDrop(), true);
    bind('bt-rr', () => this.tryRot(1));
    bind('bt-rl', () => this.tryRot(-1));
    bind('bt-hd', () => this.hardDrop());
    bind('bt-hl', () => this.hold());

    // Keyboard
    const held = {};
    let kDas = {}, kArr = {};

    document.addEventListener('keydown', e => {
      if (held[e.code]) return;
      held[e.code] = true;
      if (!this.running || this.paused_ || this.over_) {
        // Handle pause/resume from keyboard
        if ((e.code === 'Escape' || e.code === 'KeyP') && this.paused_) {
          this.resume();
        }
        return;
      }
      switch (e.code) {
        case 'ArrowLeft':
          this.move(-1);
          kDas['ArrowLeft'] = setTimeout(() => {
            kArr['ArrowLeft'] = setInterval(() => this.move(-1), 58);
          }, 185);
          break;
        case 'ArrowRight':
          this.move(1);
          kDas['ArrowRight'] = setTimeout(() => {
            kArr['ArrowRight'] = setInterval(() => this.move(1), 58);
          }, 185);
          break;
        case 'ArrowDown':
          this.softDrop();
          kDas['ArrowDown'] = setTimeout(() => {
            kArr['ArrowDown'] = setInterval(() => this.softDrop(), 58);
          }, 185);
          break;
        case 'ArrowUp': case 'KeyX':
          this.tryRot(1); break;
        case 'KeyZ': case 'ControlLeft': case 'ControlRight':
          this.tryRot(-1); break;
        case 'Space':
          e.preventDefault(); this.hardDrop(); break;
        case 'KeyC': case 'ShiftLeft': case 'ShiftRight':
          this.hold(); break;
        case 'Escape': case 'KeyP':
          this.pause(); break;
      }
    });

    document.addEventListener('keyup', e => {
      delete held[e.code];
      if (kDas[e.code]) { clearTimeout(kDas[e.code]); delete kDas[e.code]; }
      if (kArr[e.code]) { clearInterval(kArr[e.code]); delete kArr[e.code]; }
    });
  }
}

// Boot
const G = new Engine();

// Resize board whenever game screen becomes active
try {
  new MutationObserver(() => {
    if (document.getElementById('s3').classList.contains('on')) {
      setTimeout(resizeBoard, 80);
    }
  }).observe(document.getElementById('s3'), { attributes: true, attributeFilter: ['class'] });
} catch(e) {}

// Try to lock orientation on supported devices
try {
  if (screen.orientation && screen.orientation.lock) {
    screen.orientation.lock('portrait').catch(() => {});
  }
} catch(e) {}
</script>

</body>
</html>
